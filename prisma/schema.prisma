// ============================================================
// WARDA - Complete Database Schema
// Updated: Feb 2026 - Admin Portal Support
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum AdminRole {
  SUPER_ADMIN
  MANAGER
  STAFF
}

enum StaffRole {
  CARER
  SENIOR_CARER
  MANAGER
}

enum SubscriptionTier {
  PILOT
  STANDARD
  PREMIUM
}

enum CareHomeStatus {
  ACTIVE
  PILOT
  PAUSED
  CANCELLED
}

enum ResidentStatus {
  ACTIVE
  INACTIVE
  DISCHARGED
}

enum AccountType {
  B2B
  B2C
}

enum TabletStatus {
  ACTIVE
  OFFLINE
  AVAILABLE
  SHIPPING
}

enum AccessLevel {
  FULL
  VIEW_ONLY
  EMERGENCY
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum DementiaStage {
  NONE
  MILD
  MODERATE
  ADVANCED
}

enum MobilityLevel {
  INDEPENDENT
  WITH_AID
  WHEELCHAIR
  BEDBOUND
}

enum CommunicationStyle {
  CHATTY
  QUIET
  VARIES
  NON_VERBAL
}

// ============ ADMIN USERS (Portal Login) ============

model AdminUser {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String
  role        AdminRole
  careHomeId  String?
  careHome    CareHome? @relation(fields: [careHomeId], references: [id])
  cognitoSub  String?   @unique
  phone       String?
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([careHomeId])
  @@index([role])
}

// ============ CARE HOMES ============

model CareHome {
  id               String           @id @default(uuid())
  name             String
  address          String?
  city             String?
  postcode         String?
  country          String           @default("UK")
  phone            String?
  managerName      String?
  managerEmail     String?
  subscriptionTier SubscriptionTier @default(PILOT)
  status           CareHomeStatus   @default(ACTIVE)
  cqcNumber        String?
  maxResidents     Int              @default(50)
  logoUrl          String?
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  users       User[]
  staff       StaffMember[]
  tablets     Tablet[]
  adminUsers  AdminUser[]

  @@index([status])
}

// ============ USERS (Elderly Residents) ============

model User {
  id            String         @id @default(uuid())
  firstName     String
  lastName      String
  preferredName String?
  email         String?        @unique
  dateOfBirth   DateTime?
  roomNumber    String?
  pin           String?
  photoUrl      String?
  status        ResidentStatus @default(ACTIVE)
  accountType   AccountType    @default(B2B)
  moveInDate    DateTime?

  careHomeId    String?
  careHome      CareHome?      @relation(fields: [careHomeId], references: [id])
  tabletId      String?        @unique

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  profile        ResidentProfile?
  familyContacts FamilyContact[]
  messages       Message[]
  conversations  Conversation[]
  medications    Medication[]
  calendarEvents CalendarEvent[]
  healthLogs     HealthLog[]
  alerts         Alert[]
  tablet         Tablet?        @relation(fields: [tabletId], references: [id])

  @@index([careHomeId])
  @@index([status])
}

// ============ RESIDENT PROFILE (Therapeutic - Heart of Warda) ============

model ResidentProfile {
  id              String   @id @default(uuid())
  residentId      String   @unique
  resident        User     @relation(fields: [residentId], references: [id], onDelete: Cascade)

  // === Step 2: Life Background ===
  maritalStatus   String?
  spouseName      String?
  spouseDetails   String?
  children        Json?
  grandchildren   Json?
  previousCareer  String?
  grewUpIn        String?
  keyMemories     String?
  pets            String?

  // === Step 3: Sensitive Topics ===
  avoidTopics     String[]
  sensitiveTopics String[]
  traumaNotes     String?
  knownTriggers   String[]
  bereavementStatus String?

  // === Step 4: Joy & Interests ===
  joyTopics       String[]
  hobbies         String[]
  favouriteMusic  String?
  favouriteTv     String?
  joyTriggers     String[]
  favouriteMemories Json?
  favouriteFoods  String?
  sportsTeams     String?
  memories        String[]

  // === Step 5: Faith & Culture ===
  faithType       String?
  denomination    String?
  faithComfort    Boolean  @default(false)
  prayerReminders Boolean  @default(false)
  prayerTimes     Json?
  favouriteScriptures String?
  culturalBackground  String?
  useGaelic       Boolean  @default(false)
  languagePreference  String  @default("English")
  useReligious    Boolean  @default(false)
  useScottish     Boolean  @default(false)
  useWelsh        Boolean  @default(false)
  useIrish        Boolean  @default(false)
  faithPhrases    String[]

  // === Step 6: Health & Communication ===
  dementiaStage       DementiaStage?
  mobilityLevel       MobilityLevel?
  hearing             String?
  vision              String?
  communicationStyle  CommunicationStyle?
  bestTimeOfDay       String[]
  dietaryNeeds        String?

  // === Step 7: Warda's Persona ===
  wardaBackstory  String?
  wardaAge        String?
  wardaTraits     String[]
  greetingStyle   String?
  conversationTopics String[]
  hardBoundaries  String[]

  // Therapeutic goals
  therapyGoals    String[]

  // Family knowledge (JSON blob)
  familyDetails   String?

  // Questionnaire progress
  questionnaireStep    Int      @default(0)
  questionnaireComplete Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============ STAFF MEMBERS ============

model StaffMember {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String
  phone       String?
  role        StaffRole @default(CARER)
  careHomeId  String
  careHome    CareHome  @relation(fields: [careHomeId], references: [id])
  cognitoSub  String?   @unique
  isActive    Boolean   @default(true)
  assignedResidents String[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([careHomeId])
  @@index([role])
}

// ============ FAMILY CONTACTS ============

model FamilyContact {
  id              String      @id @default(uuid())
  name            String
  relationship    String
  phone           String?
  email           String?
  photoUrl        String?
  isPrimary       Boolean     @default(false)
  accessLevel     AccessLevel @default(FULL)
  inviteStatus    InviteStatus @default(PENDING)
  cognitoSub      String?     @unique
  stripeCustomerId String?

  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([inviteStatus])
}

// ============ TABLETS ============

model Tablet {
  id              String       @id @default(uuid())
  serialNumber    String       @unique
  status          TabletStatus @default(AVAILABLE)
  careHomeId      String?
  careHome        CareHome?    @relation(fields: [careHomeId], references: [id])
  lastOnline      DateTime?
  batteryLevel    Int?
  firmwareVersion String?
  shippingStatus  String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  assignedUser    User?

  @@index([careHomeId])
  @@index([status])
}

// ============ CONVERSATIONS ============

model Conversation {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  mood      String?
  summary   String?
  duration  Int?

  messages  Message[]

  @@index([userId])
  @@index([startedAt])
}

// ============ MESSAGES ============

model Message {
  id             String       @id @default(uuid())
  content        String
  sender         String
  type           String       @default("text")
  mood           String?
  isFromWarda    Boolean      @default(false)

  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  createdAt      DateTime     @default(now())

  @@index([userId])
  @@index([conversationId])
  @@index([createdAt])
}

// ============ MEDICATIONS ============

model Medication {
  id        String   @id @default(uuid())
  name      String
  dosage    String?
  frequency String?
  timeOfDay String[]
  notes     String?
  isActive  Boolean  @default(true)

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============ HEALTH LOGS ============

model HealthLog {
  id        String   @id @default(uuid())
  type      String
  value     String
  notes     String?
  recordedBy String?

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ============ ALERTS ============

model Alert {
  id          String   @id @default(uuid())
  type        String
  severity    String   @default("low")
  message     String
  isResolved  Boolean  @default(false)
  resolvedBy  String?
  resolvedAt  DateTime?

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isResolved])
  @@index([severity])
  @@index([createdAt])
}

// ============ AUDIT LOG (Admin Actions) ============

model AuditLog {
  id          String   @id @default(uuid())
  adminUserId String
  action      String
  entityType  String
  entityId    String?
  details     Json?
  ipAddress   String?

  createdAt   DateTime @default(now())

  @@index([adminUserId])
  @@index([action])
  @@index([createdAt])
}

model PushSubscription {
  id           String   @id @default(uuid())
  endpoint     String   @unique
  p256dh       String
  auth         String
  userId       String
  userType     String   @default("family")
  createdAt    DateTime @default(now())
  @@index([userId])
}


model CalendarEvent {
  id        String   @id @default(uuid())
  userId    String
  title     String
  time      String
  type      String   @default("activity")
  date      DateTime
  notes     String?
  recurring String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, date])
}
