// ============================================================
// WARDA - Complete Database Schema
// Updated: Feb 2026 - Unified Portal & Commission System
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum AdminRole {
  SUPER_ADMIN
  MANAGER
  STAFF
  GP
  FAMILY_B2B
  FAMILY_B2C
}

enum StaffRole {
  CARER
  SENIOR_CARER
  MANAGER
}

enum SubscriptionTier {
  PILOT
  STANDARD
  PREMIUM
}

enum CareHomeStatus {
  ACTIVE
  PILOT
  PAUSED
  CANCELLED
}

enum ResidentStatus {
  ACTIVE
  INACTIVE
  DISCHARGED
}

enum AccountType {
  B2B
  B2C
}

enum TabletStatus {
  ACTIVE
  OFFLINE
  AVAILABLE
  SHIPPING
}

enum AccessLevel {
  FULL
  VIEW_ONLY
  EMERGENCY
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum DementiaStage {
  NONE
  MILD
  MODERATE
  ADVANCED
}

enum MobilityLevel {
  INDEPENDENT
  WITH_AID
  WHEELCHAIR
  BEDBOUND
}

enum CommunicationStyle {
  CHATTY
  QUIET
  VARIES
  NON_VERBAL
}

// === NEW ENUMS FOR BILLING & ORDERS ===

enum BillingType {
  CARE_HOME_PAYS
  CARE_HOME_COLLECTS
  RESIDENT_PAYS
  FAMILY_PAYS
}

enum OrderStatus {
  WAITING_QUESTIONNAIRE
  WAITING_PAYMENT
  PENDING_DISPATCH
  CREDENTIALS_SENT
  SHIPPED
  ACTIVE
  PAUSED
  CANCELLED
}

enum CommissionTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

// ============ ADMIN USERS (Portal Login) ============

model AdminUser {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String
  role        AdminRole
  careHomeId  String?
  careHome    CareHome? @relation(fields: [careHomeId], references: [id])
  cognitoSub  String?   @unique
  phone       String?
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  
  // For Family users - link to their elderly relative
  linkedResidentId String?
  
  // Temporary password tracking
  tempPassword      String?
  mustChangePassword Boolean @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([careHomeId])
  @@index([role])
  @@index([linkedResidentId])
}

// ============ CARE HOMES ============

model CareHome {
  id               String           @id @default(uuid())
  name             String
  address          String?
  city             String?
  postcode         String?
  country          String           @default("UK")
  phone            String?
  managerName      String?
  managerEmail     String?
  subscriptionTier SubscriptionTier @default(PILOT)
  status           CareHomeStatus   @default(ACTIVE)
  cqcNumber        String?
  maxResidents     Int              @default(50)
  logoUrl          String?
  notes            String?
  
  // === BILLING ===
  billingEmail     String?
  billingAddress   String?
  vatNumber        String?
  
  // === COMMISSION PROGRAM ===
  commissionTier          CommissionTier @default(BRONZE)
  commissionRate          Float          @default(0.10)
  totalCommissionEarned   Float          @default(0)
  commissionBalance       Float          @default(0)
  bankAccountName         String?
  bankAccountNumber       String?
  bankSortCode            String?
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  users            User[]
  staff            StaffMember[]
  tablets          Tablet[]
  adminUsers       AdminUser[]
  commissionPayouts CommissionPayout[]
  deviceCodes       DeviceCode[]

  @@index([status])
}

// ============ USERS (Elderly Residents) ============

model User {
  id            String         @id @default(uuid())
  firstName     String
  lastName      String
  preferredName String?
  email         String?        @unique
  username      String?        @unique
  dateOfBirth   DateTime?
  roomNumber    String?
  pin           String?
  pinChangedAt    DateTime?
  pinResetAt      DateTime?
  pinResetBy      String?
  photoUrl      String?
  assignedDevices DeviceCode[] @relation("DeviceUser")
  status        ResidentStatus @default(ACTIVE)
  accountType   AccountType    @default(B2B)
  moveInDate    DateTime?

  careHomeId    String?
  careHome      CareHome?      @relation(fields: [careHomeId], references: [id])
  tabletId      String?        @unique

  // === BILLING & ORDER STATUS ===
  billingType       BillingType   @default(CARE_HOME_PAYS)
  billingEmail      String?
  orderStatus       OrderStatus   @default(WAITING_QUESTIONNAIRE)
  stripeCustomerId  String?
  stripePaymentIntentId String?
  
  // Order tracking dates
  paymentLinkSentAt   DateTime?
  paymentConfirmedAt  DateTime?
  credentialsSentAt   DateTime?
  dispatchedAt        DateTime?
  activatedAt         DateTime?
  
  // Referral tracking (for commission)
  referredByCareHomeId String?
  isCommissionEligible Boolean @default(false)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  profile        ResidentProfile?
  familyContacts FamilyContact[]
  messages       Message[]
  conversations  Conversation[]
  medications    Medication[]
  calendarEvents CalendarEvent[]
  healthLogs     HealthLog[]
  alerts         Alert[]
  tablet         Tablet?        @relation(fields: [tabletId], references: [id])

  @@index([careHomeId])
  @@index([status])
  @@index([orderStatus])
  @@index([billingType])
}

// ============ RESIDENT PROFILE (Therapeutic - Heart of Warda) ============

model ResidentProfile {
  id              String   @id @default(uuid())
  residentId      String   @unique
  resident        User     @relation(fields: [residentId], references: [id], onDelete: Cascade)

  // === Step 2: Life Background ===
  maritalStatus   String?
  spouseName      String?
  spouseDetails   String?
  children        Json?
  grandchildren   Json?
  previousCareer  String?
  grewUpIn        String?
  keyMemories     String?
  pets            String?

  // === Step 3: Sensitive Topics ===
  avoidTopics     String[]
  sensitiveTopics String[]
  traumaNotes     String?
  knownTriggers   String[]
  bereavementStatus String?

  // === Step 4: Joy & Interests ===
  joyTopics       String[]
  hobbies         String[]
  favouriteMusic  String?
  favouriteTv     String?
  joyTriggers     String[]
  favouriteMemories Json?
  favouriteFoods  String?
  sportsTeams     String?
  memories        String[]

  // === Step 5: Faith & Culture ===
  faithType       String?
  denomination    String?
  faithComfort    Boolean  @default(false)
  prayerReminders Boolean  @default(false)
  prayerTimes     Json?
  favouriteScriptures String?
  culturalBackground  String?
  useGaelic       Boolean  @default(false)
  languagePreference  String  @default("English")
  useReligious    Boolean  @default(false)
  useScottish     Boolean  @default(false)
  useWelsh        Boolean  @default(false)
  useIrish        Boolean  @default(false)
  faithPhrases    String[]

  // === Step 6: Health & Communication ===
  dementiaStage       DementiaStage?
  mobilityLevel       MobilityLevel?
  hearing             String?
  vision              String?
  communicationStyle  CommunicationStyle?
  bestTimeOfDay       String[]
  dietaryNeeds        String?

  // === Step 7: Warda's Persona ===
  wardaBackstory  String?
  wardaAge        String?
  wardaTraits     String[]
  greetingStyle   String?
  conversationTopics String[]
  hardBoundaries  String[]

  // Therapeutic goals
  therapyGoals    String[]

  // Family knowledge (JSON blob)
  familyDetails   String?

  // Questionnaire progress
  questionnaireStep    Int      @default(0)
  questionnaireComplete Boolean @default(false)
  questionnaireToken   String?  @unique
  // === Step 1: Identity ===
  gender              String?
  nationality         String?
  languagesSpoken     String[]
  emergencyContact    String?
  emergencyPhone      String?
  // === Step 2: Life Story additions ===
  education           String?
  militaryService     Boolean  @default(false)
  militaryBranch      String?
  importantDates      Json?
  proudestAchievement String?
  missesAboutOldLife  String?
  placesLived         String[]
  // === Step 3: Family Connections ===
  familyTree          Json?
  primaryFamilyContact String?
  familyDynamicsNotes String?
  favouriteFamilyMember String?
  familyNicknames     Json?
  // === Step 4: Sensitive additions ===
  lossTimeline        Json?
  confusionTriggers   String[]
  anxietyTriggers     String[]
  sundowningPatterns  String?
  redirectionStrategies String[]
  safeRedirectTopics  String[]
  // === Step 5: Joy additions ===
  favouriteRadio      String?
  favouriteBooks      String?
  favouriteGames      String[]
  dailyRoutines       Json?
  socialPreference    String?
  conversationStarters String[]
  thingsThatMakeLaugh String[]
  favouritePlaces     String[]
  bucketList          String[]
  // === Step 6: Faith additions ===
  religiousCelebrations String[]
  culturalFoods       String[]
  traditionalSongs    String[]
  culturalPractices   String?
  politicalGuidance   String?
  historicalEvents    String[]
  dialectWords        Json?
  // === Step 7: Health additions ===
  medications         Json?
  sleepPattern        String?
  painManagement      String?
  moodPatterns        Json?
  appetite            String?
  fallRisk            String?
  allergies           String[]
  gpName              String?
  gpPractice          String?
  // === Step 8: Communication Profile ===
  voicePreference     String?
  responseLengthPref  String?
  humourStyle         String?
  formalityLevel      String?
  discomfortSigns     String?
  happinessExpressions String?
  conversationPace    String?
  repetitionHandling  String?
  conversationEnding  String?
  // === Step 9: Daily Routines ===
  wakeUpTime          String?
  bedTime             String?
  mealTimes           Json?
  medicationSchedule  Json?
  tvSchedule          Json?
  activitySchedule    Json?
  visitorPatterns     Json?
  checkInTimes        String[]
  weatherInterest     Boolean  @default(false)
  newsPreference      String?
  // === Step 10: Enhanced Persona ===
  morningGreetings    String[]
  afternoonGreetings  String[]
  eveningGreetings    String[]
  nightGreetings      String[]
  comfortPhrases      String[]
  proactiveTopics     String[]
  healthConcernResponses String[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============ STAFF MEMBERS ============

model StaffMember {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String
  phone       String?
  role        StaffRole @default(CARER)
  careHomeId  String
  careHome    CareHome  @relation(fields: [careHomeId], references: [id])
  cognitoSub  String?   @unique
  isActive    Boolean   @default(true)
  assignedResidents String[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([careHomeId])
  @@index([role])
}

// ============ FAMILY CONTACTS ============

model FamilyContact {
  id              String      @id @default(uuid())
  name            String
  relationship    String
  phone           String?
  email           String?
  photoUrl        String?
  isPrimary       Boolean     @default(false)
  accessLevel     AccessLevel @default(FULL)
  inviteStatus    InviteStatus @default(PENDING)
  cognitoSub      String?     @unique
  stripeCustomerId String?

  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([inviteStatus])
}

// ============ TABLETS ============

model Tablet {
  id              String       @id @default(uuid())
  serialNumber    String       @unique
  status          TabletStatus @default(AVAILABLE)
  careHomeId      String?
  careHome        CareHome?    @relation(fields: [careHomeId], references: [id])
  lastOnline      DateTime?
  batteryLevel    Int?
  firmwareVersion String?
  shippingStatus  String?
  trackingNumber  String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  assignedUser    User?

  @@index([careHomeId])
  @@index([status])
}

// ============ CONVERSATIONS ============

model Conversation {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  mood      String?
  summary   String?
  duration  Int?

  messages  Message[]

  @@index([userId])
  @@index([startedAt])
}

// ============ MESSAGES ============

model Message {
  id             String       @id @default(uuid())
  content        String
  sender         String
  type           String       @default("text")
  mood           String?
  isFromWarda    Boolean      @default(false)

  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  // === Family Communication Fields ===
  recipientId    String?
  senderId       String?
  senderType     String?      // FAMILY, RESIDENT, STAFF, WARDA
  senderName     String?
  isDelivered    Boolean      @default(false)
  deliveredAt    DateTime?
  mediaUrl       String?      // S3 key for photos/voice
  thumbnailUrl   String?      // S3 key for photo thumbnail

  createdAt      DateTime     @default(now())

  @@index([userId])
  @@index([conversationId])
  @@index([createdAt])
  @@index([recipientId])
  @@index([isDelivered])
}

// ============ MEDICATIONS ============

model Medication {
  id        String   @id @default(uuid())
  name      String
  dosage    String?
  frequency String?
  timeOfDay String[]
  notes     String?
  isActive  Boolean  @default(true)

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============ HEALTH LOGS ============

model HealthLog {
  id        String   @id @default(uuid())
  type      String
  value     String
  notes     String?
  recordedBy String?

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ============ ALERTS ============

model Alert {
  id          String   @id @default(uuid())
  type        String
  severity    String   @default("low")
  message     String
  isResolved  Boolean  @default(false)
  resolvedBy  String?
  resolvedAt  DateTime?

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isResolved])
  @@index([severity])
  @@index([createdAt])
}

// ============ AUDIT LOG (Admin Actions) ============

model AuditLog {
  id          String   @id @default(uuid())
  adminUserId String
  action      String
  entityType  String
  entityId    String?
  details     Json?
  ipAddress   String?

  createdAt   DateTime @default(now())

  @@index([adminUserId])
  @@index([action])
  @@index([createdAt])
}

model PushSubscription {
  id           String   @id @default(uuid())
  endpoint     String   @unique
  p256dh       String
  auth         String
  userId       String
  userType     String   @default("family")
  createdAt    DateTime @default(now())
  @@index([userId])
}

model CalendarEvent {
  id        String   @id @default(uuid())
  userId    String
  title     String
  time      String
  type      String   @default("activity")
  date      DateTime
  notes     String?
  recurring String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, date])
}

// ============ SUBSCRIPTIONS (Updated) ============

model Subscription {
  id                    String    @id @default(uuid())
  careHomeId            String?
  userId                String?
  email                 String
  name                  String
  planId                String
  planName              String
  amount                Int
  currency              String    @default("gbp")
  interval              String    @default("month")
  residentCount         Int       @default(1)
  status                String    @default("active")
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelledAt           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  invoices              Invoice[]
  @@index([status])
  @@index([careHomeId])
  @@index([userId])
}

// ============ INVOICES (Updated) ============

model Invoice {
  id              String        @id @default(uuid())
  subscriptionId  String?
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  // Direct billing (without subscription)
  careHomeId      String?
  userId          String?
  
  // Invoice details
  invoiceNumber   String?       @unique
  amount          Int
  currency        String        @default("gbp")
  status          InvoiceStatus @default(DRAFT)
  
  // Line items
  lineItems       Json?
  
  // Stripe
  stripeInvoiceId String?
  stripePaymentUrl String?
  
  // Dates
  issueDate       DateTime      @default(now())
  dueDate         DateTime?
  paidAt          DateTime?
  
  // PDF
  pdfUrl          String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([subscriptionId])
  @@index([careHomeId])
  @@index([status])
}

// ============ COMMISSION PAYOUTS (New) ============

model CommissionPayout {
  id          String       @id @default(uuid())
  careHomeId  String
  careHome    CareHome     @relation(fields: [careHomeId], references: [id])
  
  // Payout details
  amount      Float
  period      String       // "2026-02" format
  referrals   Int          // Number of paying referrals that month
  rate        Float        // Commission rate at time of payout
  
  // Status
  status      PayoutStatus @default(PENDING)
  paidAt      DateTime?
  reference   String?      // Bank transfer reference
  
  // Notes
  notes       String?
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([careHomeId])
  @@index([status])
  @@index([period])
}

// ============ EMAIL TEMPLATES (New) ============

model EmailTemplate {
  id          String   @id @default(uuid())
  name        String   @unique
  subject     String
  body        String
  variables   String[] // List of variable names like ["name", "pin", "tempPassword"]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============ SYSTEM SETTINGS (New) ============

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Device Activation Codes - for tablet setup
model DeviceCode {
  id              String    @id @default(uuid())
  code            String    @unique // e.g., "SUNNY-ABCD-1234-EFGH"
  careHomeId      String
  careHome        CareHome  @relation(fields: [careHomeId], references: [id])
  deviceName      String?   // e.g., "Lounge Tablet 1"
  status          String    @default("ACTIVE") // ACTIVE, SUSPENDED, EXPIRED, REVOKED
  suspendReason   String?   // "Payment overdue", "Subscription cancelled"
  createdAt       DateTime  @default(now())
  expiresAt       DateTime?
  activatedAt     DateTime?
  lastValidatedAt DateTime?
  createdBy       String?   // Admin who created it
  assignedUserId  String?
  assignedUser    User?     @relation("DeviceUser", fields: [assignedUserId], references: [id])
  
  @@index([careHomeId])
  @@index([code])
  @@index([status])
}
